import {
  get_slot_api,
  get_utxos_dbsync,
  SubmitBuilder,
} from "@studiowebux/cardano";

import { DatabaseBuilder } from "../src/db/postgres.ts";
import { TxBuilder } from "../src/csl/tx_builder.class.ts";
import { get_utxos_api } from "../src/lib/utxo.api.ts";

const sql = new DatabaseBuilder()
  .setReadUrl("postgres://postgres:example@192.168.20.105:5432/cexplorer")
  .build()
  .getReadConnection();

// http://192.168.20.105:3010/addresses/addr_test1qqx93zaarmlqwv5ptslvaclyxt3kke2296kpaf6vfkz87kyzgpt30akcklt630wjw4cqzc253k6ud63c5kh9jexldmvs0h7dq6/utxos
Deno.test.ignore("Get UTXOs from Blockfrost RYO", async () => {
  const address =
    "addr_test1qqx93zaarmlqwv5ptslvaclyxt3kke2296kpaf6vfkz87kyzgpt30akcklt630wjw4cqzc253k6ud63c5kh9jexldmvs0h7dq6";

  const utxos = await get_utxos_api(
    "http://192.168.20.105:3010",
    "NONE",
    address,
  );
  // console.log("Utxos", utxos, utxos.length);
  console.log("Utxos blockfrost", utxos.length);
});

// http://192.168.20.105:3010/addresses/addr_test1qqx93zaarmlqwv5ptslvaclyxt3kke2296kpaf6vfkz87kyzgpt30akcklt630wjw4cqzc253k6ud63c5kh9jexldmvs0h7dq6/utxos
Deno.test.ignore("Get UTXOs from DB Sync", async () => {
  const address =
    "addr_test1qqx93zaarmlqwv5ptslvaclyxt3kke2296kpaf6vfkz87kyzgpt30akcklt630wjw4cqzc253k6ud63c5kh9jexldmvs0h7dq6";
  const blockfrost_url = "http://192.168.20.105:3010";
  const blockfrost_api_key = "not_used";
  const utxos = await get_utxos_dbsync(sql, address);
  console.log("Utxos db sync", utxos, utxos.length);

  await sql.end();

  const tip_slot: number =
    (await get_slot_api(blockfrost_url, blockfrost_api_key)!) + 50_000;

  const tx_builder = new TxBuilder()
    .with_hide_metadata(false)
    .with_receiver_address(address)
    .with_sender_address(address)
    // .with_nft_cost_in_lovelace(969_750)
    .with_utxos(utxos)
    .build()
    .parse_utxos()
    .set_ttl(tip_slot)
    .set_inputs() // to get all inputs and put them under ONE utxo
    .add_inputs()
    .build_body_and_hash()
    .add_signers()
    .set_network_id(0) // testnet
    .build_tx()
    .assemble_tx()
    .remove_metadata();

  console.log(tx_builder);

  console.debug(tx_builder.get_tx_to_sign()?.to_hex());
});

Deno.test("Submit", async () => {
  // Signature generated in the browser console.
  const sig =
    "a100818258201d94ef303aeefff9964e4fa156d68e78b4570862a3875d15ca06b813d54641bc5840df9a99944b88085a2c1aeef194282a093e1b26f926087f65629529fede0f8db5c264ff4d873f7ceb1f62b44b5cf35b9f8e28013002e92bc87799e6d5edb6da08";
  const cardano_submit_api_base_url = "http://192.168.20.105:8191";

  const submit = new SubmitBuilder()
    .with_signature(sig)
    .with_transaction(
      "84a400d901028282582017dc66ed18d17895a20e800e956a8ea789339ee4cf1456b6ab5a5f107b69235a0082582017dc66ed18d17895a20e800e956a8ea789339ee4cf1456b6ab5a5f107b69235a010181825839000c588bbd1efe0732815c3ecee3e432e36b654a2eac1ea74c4d847f5882405717f6d8b7d7a8bdd275700161548db5c6ea38a5ae5964df6ed9821a285a2c5fa3581c4e081a9911d3b9a0d3b13d8708ada17aa1536cf6eba343a6761e0d9ea35764616f676f72615f64756e67656f6e5f3663636534376301581864616f676f72615f64756e67656f6e5f343435613435316201581864616f676f72615f64756e67656f6e5f366439643331623001581cef698582c0338d1ff3f76a3a88b4dcb9f6e0729d80e949670f757379a44361697203446669726501456561727468044661657468657206581cfae7fb2d73a5ab337f7b8230753e238ce0b769574f76c1a85bd70831b8455364616f676f72615f675f375f65303164636566015364616f676f72615f735f305f62626663633232015364616f676f72615f735f325f35353434306330015364616f676f72615f735f335f63373337643964015364616f676f72615f735f345f36386531353639015364616f676f72615f735f375f35643339643033015364616f676f72615f735f375f63623936323862015364616f676f72615f735f375f66356433343465015464616f676f72615f675f305f3330656137336232015464616f676f72615f675f315f3565376631623566015464616f676f72615f675f325f3666313665386261015464616f676f72615f675f325f3739653461323935015464616f676f72615f675f335f3730666265653036015464616f676f72615f675f345f3165356131613264015464616f676f72615f675f355f3365646431633163015464616f676f72615f675f355f3439616163393261015464616f676f72615f675f365f3166383265383666015464616f676f72615f675f375f3732626634623832015464616f676f72615f675f395f3562373765613139015464616f676f72615f735f305f3331343231633166015464616f676f72615f735f305f3339353232393835015464616f676f72615f735f305f3361316662663462015464616f676f72615f735f305f3363323138613036015464616f676f72615f735f305f3363663931616561015464616f676f72615f735f305f3435393263393163015464616f676f72615f735f305f3636666361313465015464616f676f72615f735f315f3566666136623066015464616f676f72615f735f315f3661656533396262015464616f676f72615f735f315f3665633232373931015464616f676f72615f735f315f3763353565316339015464616f676f72615f735f325f3365633133373766015464616f676f72615f735f325f3434653938643961015464616f676f72615f735f335f3164313036613436015464616f676f72615f735f335f3261653631366631015464616f676f72615f735f335f3332386338323637015464616f676f72615f735f335f3734353366383964015464616f676f72615f735f345f3163623133646139015464616f676f72615f735f345f3361323731363434015464616f676f72615f735f355f3233323030616362015464616f676f72615f735f365f3539633765343739015464616f676f72615f735f375f3236383463343566015464616f676f72615f735f385f3230623334383831015464616f676f72615f735f385f3437613232366330015464616f676f72615f735f385f3535363764326561015464616f676f72615f735f385f3635323334636266015464616f676f72615f735f395f3166346135393362015464616f676f72615f735f395f3261383365306336015464616f676f72615f735f395f3366363636313661015464616f676f72615f735f395f3465393230353335015464616f676f72615f735f395f3535623664613030015464616f676f72615f735f395f3665376634336636015464616f676f72615f735f395f376533343739366301581a64616f676f72615f6368617261637465725f366162633763663801581b64616f676f72615f67656e6572616c6973745f313530393363383101581b64616f676f72615f67656e6572616c6973745f323361643737626201581b64616f676f72615f67656e6572616c6973745f333164346336303801581b64616f676f72615f67656e6572616c6973745f333333623764333101581b64616f676f72615f67656e6572616c6973745f333563346564663801581b64616f676f72615f67656e6572616c6973745f343531393861626301581b64616f676f72615f67656e6572616c6973745f353334363739386601581b64616f676f72615f67656e6572616c6973745f353463316537346301581b64616f676f72615f67656e6572616c6973745f363737343133366101581b64616f676f72615f67656e6572616c6973745f366230356332303401581b64616f676f72615f67656e6572616c6973745f366664313832393001581b64616f676f72615f67656e6572616c6973745f373134333162383801581b64616f676f72615f67656e6572616c6973745f373761376336363201581b64616f676f72615f67656e6572616c6973745f376139343064346501581b64616f676f72615f7370656369616c6973745f353561646437363801581b64616f676f72615f7370656369616c6973745f353832343531653101021a0003cad1031a00232d90a0f5f6",
    )
    .with_cardano_submit_api_base_url(cardano_submit_api_base_url)
    .build();

  await submit.assemble_tx().submit_tx();
  const hash = submit.get_hash();

  console.log(hash);
});
